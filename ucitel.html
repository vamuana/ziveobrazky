<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8" />
    <title>Živé obrázky – Editor úlohy</title>
    <style>
        /* RESET & BASIC STYLING */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Comic Sans MS', Arial, sans-serif;
            background: linear-gradient(to bottom, #41eafa, #89F8CE);
            color: #4e342e;
            overflow: hidden;
        }
        /* HEADER */
        header {
            background: linear-gradient(to bottom, #89F8CE, #41eafa);
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid #FFF4B5;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        header .button-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        header button {
            background: #ffe0ec;
            border: 2px solid #FFF4B5;
            padding: 10px 16px;
            border-radius: 14px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }
        header button:hover {
            background: #ffd1e3;
            transform: translateY(-2px) scale(1.05);
        }
        /* SCENE CONTAINER */
        #scene {
            position: relative;
            height: calc(100vh - 80px);
            background: #d0eaff;
            margin: 0 auto;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }
        .object {
            position: absolute;
            width: 100px;
            height: 100px;
            cursor: grab;
        }
        .selected {
            outline: 2px solid red;
        }
    </style>
</head>
<body>
<header>
    <div class="button-group">
        <!-- Background & Object Controls -->
        <input type="file" id="backgroundUpload" style="display: none;" accept="image/*" />
        <button id="loadBackground">Načítaj pozadie</button>
        <input type="file" id="objectUpload" style="display: none;" accept="image/*" />
        <button id="addObject">Vlož objekt</button>
        <button id="copyObject">Vlož kópiu objektu</button>
        <button id="deleteObject">Zruš objekt</button>
    </div>
    <div class="button-group">
        <!-- Editing & Saving -->
        <button id="configureProgram">Programuj</button>
        <button id="editText">Vlož text</button>
        <button id="saveProject">Zapíš projekt</button>
    </div>
</header>
<main>
    <div id="scene"></div>
</main>
<script>
    // --------------------- Project Model ---------------------
    // Load project from localStorage or create a new default project.
    let project = JSON.parse(localStorage.getItem("currentProject")) || {
        assignmentTitle: "Nová úloha",
        assignmentDescription: "Zadaj sem popis úlohy.",
        background: "",
        objects: [] // Each object: { id, image, x, y, rotation, scale, blocks: [] }
    };

    // Save the project JSON to localStorage.
    function saveProject() {
        localStorage.setItem("currentProject", JSON.stringify(project));
    }

    // --------------------- Scene Rendering ---------------------
    function renderScene() {
        const scene = document.getElementById('scene');
        scene.innerHTML = "";
        if (project.background) {
            scene.style.backgroundImage = `url('${project.background}')`;
            scene.style.backgroundSize = 'cover';
        } else {
            scene.style.backgroundImage = "";
        }
        project.objects.forEach(obj => {
            const img = document.createElement('img');
            img.src = obj.image;
            img.className = 'object';
            img.style.left = obj.x + 'px';
            img.style.top = obj.y + 'px';
            img.style.transform = `rotate(${obj.rotation}deg) scale(${obj.scale})`;
            img.dataset.id = obj.id;
            // Enable dragging and selection.
            img.addEventListener('mousedown', startDrag);
            img.addEventListener('click', (e) => {
                e.stopPropagation();
                selectObject(obj.id);
            });
            scene.appendChild(img);
        });
    }

    // --------------------- Object Selection and Dragging ---------------------
    let selectedObjectId = null;
    function selectObject(id) {
        selectedObjectId = id;
        document.querySelectorAll('.object').forEach(el => el.classList.remove('selected'));
        const selEl = document.querySelector(`img.object[data-id="${id}"]`);
        if (selEl) selEl.classList.add('selected');
    }
    let dragOffsetX, dragOffsetY;
    function startDrag(e) {
        const objEl = e.target;
        selectedObjectId = objEl.dataset.id;
        dragOffsetX = e.offsetX;
        dragOffsetY = e.offsetY;
        document.addEventListener('mousemove', dragObject);
        document.addEventListener('mouseup', stopDrag);
    }
    function dragObject(e) {
        const sceneRect = document.getElementById('scene').getBoundingClientRect();
        let x = e.clientX - sceneRect.left - dragOffsetX;
        let y = e.clientY - sceneRect.top - dragOffsetY;
        const objEl = document.querySelector(`img.object[data-id="${selectedObjectId}"]`);
        if (objEl) {
            objEl.style.left = x + 'px';
            objEl.style.top = y + 'px';
        }
        project.objects = project.objects.map(obj => {
            if (obj.id === selectedObjectId) {
                obj.x = x;
                obj.y = y;
            }
            return obj;
        });
    }
    function stopDrag(e) {
        document.removeEventListener('mousemove', dragObject);
        document.removeEventListener('mouseup', stopDrag);
        saveProject();
    }

    // --------------------- Button Handlers ---------------------
    // 1. Load Background Image
    document.getElementById('loadBackground').addEventListener('click', () => {
        document.getElementById('backgroundUpload').click();
    });
    document.getElementById('backgroundUpload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                project.background = evt.target.result;
                saveProject();
                renderScene();
            };
            reader.readAsDataURL(file);
        }
    });

    // 2. Add New Object
    document.getElementById('addObject').addEventListener('click', () => {
        document.getElementById('objectUpload').click();
    });
    document.getElementById('objectUpload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                const newObj = {
                    id: Date.now().toString(),
                    image: evt.target.result,
                    x: 50,
                    y: 50,
                    rotation: 0,
                    scale: 1,
                    blocks: []
                };
                project.objects.push(newObj);
                saveProject();
                renderScene();
            };
            reader.readAsDataURL(file);
        }
    });

    // 3. Copy Selected Object
    document.getElementById('copyObject').addEventListener('click', () => {
        if (!selectedObjectId) {
            alert("Vyberte objekt na kopírovanie.");
            return;
        }
        const orig = project.objects.find(obj => obj.id === selectedObjectId);
        if (orig) {
            const copy = { ...orig, id: Date.now().toString(), x: orig.x + 20, y: orig.y + 20 };
            project.objects.push(copy);
            saveProject();
            renderScene();
        }
    });

    // 4. Delete Selected Object
    document.getElementById('deleteObject').addEventListener('click', () => {
        if (!selectedObjectId) {
            alert("Vyberte objekt na zrušenie.");
            return;
        }
        if (confirm("Naozaj chcete zrušiť tento objekt?")) {
            project.objects = project.objects.filter(obj => obj.id !== selectedObjectId);
            selectedObjectId = null;
            saveProject();
            renderScene();
        }
    });

    // 5. Block Editor for Selected Object ("Programuj")
    document.getElementById('configureProgram').addEventListener('click', () => {
        if (!selectedObjectId) {
            alert("Vyberte objekt, ktorý chcete programovať.");
            return;
        }
        // Get current blocks (if any) as a comma-separated string.
        const obj = project.objects.find(o => o.id === selectedObjectId);
        const currentBlocks = obj.blocks.join(", ");
        let input = prompt("Zadajte bloky oddelené čiarkou (napr. štart, dopredu, čakaj):", currentBlocks);
        if (input !== null) {
            // Split input by commas and trim spaces.
            obj.blocks = input.split(",").map(s => s.trim()).filter(s => s !== "");
            saveProject();
            alert("Bloky boli aktualizované:\n" + obj.blocks.join(", "));
        }
    });

    // 6. Text Editor for Assignment ("Vlož text")
    document.getElementById('editText').addEventListener('click', () => {
        // Use prompt to update the assignment title and description.
        let newTitle = prompt("Zadajte názov úlohy:", project.assignmentTitle);
        if (newTitle !== null) {
            project.assignmentTitle = newTitle.trim() || project.assignmentTitle;
        }
        let newDesc = prompt("Zadajte popis úlohy:", project.assignmentDescription);
        if (newDesc !== null) {
            project.assignmentDescription = newDesc.trim() || project.assignmentDescription;
        }
        saveProject();
        alert("Údaje o úlohe boli aktualizované.");
    });

    // 7. Save (Export) Project as JSON
    document.getElementById('saveProject').addEventListener('click', () => {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(project, null, 2));
        const a = document.createElement('a');
        a.setAttribute("href", dataStr);
        a.setAttribute("download", project.assignmentTitle + ".json");
        document.body.appendChild(a);
        a.click();
        a.remove();
    });

    // --------------------- Initialization ---------------------
    renderScene();
</script>
</body>
</html>
